#!/usr/bin/env bash
set -euo pipefail

LABEL=""
WORKDIR=""
SESSION=""
SOCKET="${TMPDIR:-/tmp}/clawdbot-tmux-sockets/clawdbot.sock"
SEND_WAKE=true
LINT_CMD="npm run lint"
BUILD_CMD="npm run build"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --label) LABEL="$2"; shift 2 ;;
    --workdir) WORKDIR="$2"; shift 2 ;;
    --session) SESSION="$2"; shift 2 ;;
    --socket) SOCKET="$2"; shift 2 ;;
    --no-wake) SEND_WAKE=false; shift ;;
    --lint-cmd) LINT_CMD="$2"; shift 2 ;;
    --build-cmd) BUILD_CMD="$2"; shift 2 ;;
    *) echo "Unknown arg: $1"; exit 1 ;;
  esac
done

if [[ -z "$LABEL" || -z "$WORKDIR" ]]; then
  echo "Usage: $0 --label <label> --workdir <dir> [--session cc-xxx] [--socket path] [--no-wake]"
  exit 1
fi

SESSION="${SESSION:-cc-${LABEL}}"
REPORT_JSON="/tmp/${SESSION}-completion-report.json"
REPORT_MD="/tmp/${SESSION}-completion-report.md"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WAKE_SCRIPT="$SCRIPT_DIR/wake.sh"
HISTORY_FILE="$SCRIPT_DIR/../TASK_HISTORY.jsonl"
EXECUTION_LOG="/tmp/${SESSION}-execution-events.jsonl"
EXECUTION_SUMMARY="/tmp/${SESSION}-execution-summary.json"

cd "$WORKDIR"

status_short="$(git status --short || true)"
changed_files="$(git diff --name-only || true)"
diff_stat="$(git diff --stat || true)"

lint_ok=true
lint_out="skipped"
if [[ -n "$LINT_CMD" ]]; then
  if ! lint_out="$($LINT_CMD 2>&1)"; then
    lint_ok=false
  fi
fi

build_ok=true
build_out="skipped"
if [[ -n "$BUILD_CMD" ]]; then
  if ! build_out="$($BUILD_CMD 2>&1)"; then
    build_ok=false
  fi
fi

risk="low"
recommendation="keep"
if [[ "$lint_ok" != true || "$build_ok" != true ]]; then
  risk="high"
  recommendation="partial_rollback"
fi

scope_drift=false

# Build JSON report using jq (no shell variable injection into code)
jq -n \
  --arg label "$LABEL" \
  --arg workdir "$WORKDIR" \
  --arg changed_files "$changed_files" \
  --arg diff_stat "$diff_stat" \
  --argjson lint_ok "$lint_ok" \
  --arg lint_out "${lint_out:0:4000}" \
  --argjson build_ok "$build_ok" \
  --arg build_out "${build_out:0:4000}" \
  --arg risk "$risk" \
  --argjson scope_drift "$scope_drift" \
  --arg recommendation "$recommendation" \
  '{
    label: $label,
    workdir: $workdir,
    changedFiles: ($changed_files | if . == "" then [] else split("\n") | map(select(. != "")) end),
    diffStat: $diff_stat,
    lint: { ok: $lint_ok, summary: $lint_out },
    build: { ok: $build_ok, summary: $build_out },
    risk: $risk,
    scopeDrift: $scope_drift,
    recommendation: $recommendation,
    notes: "Generated by complete-tmux-task.sh"
  }' > "$REPORT_JSON"

cat > "$REPORT_MD" <<EOF
# Claude Code Completion Report
- label: $LABEL
- workdir: $WORKDIR
- session: $SESSION
- report_json: $REPORT_JSON

## changed files

$changed_files

## diff stat

$diff_stat

## quality gates
- lint: $lint_ok
- build: $build_ok

## recommendation
- risk: $risk
- recommendation: $recommendation
- scope_drift: $scope_drift
EOF

echo "REPORT_JSON=$REPORT_JSON"
echo "REPORT_MD=$REPORT_MD"

# ========== 闭环反馈：记录任务历史 ==========

# 判断任务是否成功
task_success=true
failure_reason=""

if [[ "$lint_ok" != true ]]; then
  task_success=false
  failure_reason="lint_failed"
elif [[ "$build_ok" != true ]]; then
  task_success=false
  failure_reason="build_failed"
elif [[ -z "$changed_files" ]]; then
  # 没有任何改动可能意味着任务没有真正执行
  task_success=false
  failure_reason="no_changes"
fi

# 从执行日志中提取错误信息（如果有）
if [[ -f "$EXECUTION_LOG" ]] && [[ "$task_success" != true ]]; then
  error_detail=$(grep '"event":"tool_error"' "$EXECUTION_LOG" 2>/dev/null | tail -3 | jq -r '.detail' 2>/dev/null | tr '\n' '; ' | head -c 200 || echo "")
  if [[ -n "$error_detail" ]]; then
    failure_reason="${failure_reason}: ${error_detail}"
  fi
fi

# 从执行摘要中获取统计信息
exec_duration=0
exec_errors=0
if [[ -f "$EXECUTION_SUMMARY" ]]; then
  exec_duration=$(jq -r '.durationSeconds // 0' "$EXECUTION_SUMMARY" 2>/dev/null || echo "0")
  exec_errors=$(jq -r '.eventCounts.errors // 0' "$EXECUTION_SUMMARY" 2>/dev/null || echo "0")
fi

# 写入历史记录
jq -n -c \
  --arg timestamp "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
  --arg label "$LABEL" \
  --arg workdir "$WORKDIR" \
  --argjson success "$task_success" \
  --arg failure_reason "$failure_reason" \
  --arg risk "$risk" \
  --arg recommendation "$recommendation" \
  --argjson duration "$exec_duration" \
  --argjson errors "$exec_errors" \
  --argjson files_changed "$(echo "$changed_files" | grep -c . || echo 0)" \
  '{
    timestamp: $timestamp,
    label: $label,
    workdir: $workdir,
    success: $success,
    failureReason: $failure_reason,
    risk: $risk,
    recommendation: $recommendation,
    durationSeconds: $duration,
    executionErrors: $errors,
    filesChanged: $files_changed
  }' >> "$HISTORY_FILE"

echo "HISTORY_RECORDED=true"
echo "TASK_SUCCESS=$task_success"
if [[ "$task_success" != true ]]; then
  echo "FAILURE_REASON=$failure_reason"
fi

# ========== 闭环反馈结束 ==========

if [[ "$SEND_WAKE" == true ]]; then
  bash "$WAKE_SCRIPT" "Claude Code done (${LABEL}) report=$REPORT_JSON" now
  echo "WAKE_SENT=true"
fi
