---
name: claude-code
description: Trigger Claude Code development tasks in observable tmux sessions with stable startup, progress visibility, and completion callback to OpenClaw. Use when user asks to run coding work via Claude Code and wants to SSH in, monitor progress, and get auto-notified for review after completion.
---

# Claude Code Orchestrator (tmux-first)

Use tmux-based orchestration for long coding tasks to avoid silent hangs and make progress observable.

## Default Project Directory

**新项目默认创建在：**
```
/Users/yingze/Library/Mobile Documents/iCloud~md~obsidian/Documents/Ed_Brain/AI/
```

除非用户明确指定其他目录，否则所有新项目都放在这里。

## Standard workflow

1. Create prompt file (avoid long shell quote issues).
2. Start a dedicated tmux session.
3. Launch `claude --dangerously-skip-permissions` in interactive mode.
4. Paste prompt into Claude.
5. Require callback command in prompt (via wrapper):
   `bash {baseDir}/scripts/wake.sh "..." now`
6. Share socket/session attach command with user.
7. On completion, review diff + lint/build + risk summary.

## Start command

```bash
bash {baseDir}/scripts/start-tmux-task.sh \
  --label "gallery-detail-polish" \
  --workdir "/Users/yaxuan/.openclaw/workspace/work/active/02-gallery-ops" \
  --prompt-file "/Users/yaxuan/Downloads/gallery-website-design-system.md" \
  --task "参考这个修改我当前的画廊官网，注意优先打磨细节和质感，对整体结构展示先不用大改。"
```

## Monitor commands

```bash
# attach
bash {baseDir}/scripts/monitor-tmux-task.sh --attach --session <session>

# capture last 200 lines
bash {baseDir}/scripts/monitor-tmux-task.sh --session <session> --lines 200
```

## Task overview

List all running `cc-*` tasks at a glance - useful for "butler-style" summaries.

```bash
# Human-readable one-liner per task
bash {baseDir}/scripts/list-tasks.sh

# Structured JSON array (pipe to jq, feed to OpenClaw, etc.)
bash {baseDir}/scripts/list-tasks.sh --json | jq .
```

Options:
- `--lines <n>` - number of trailing pane lines to capture per task (default 20).
- `--socket <path>` - tmux socket path (default `$TMPDIR/clawdbot-tmux-sockets/clawdbot.sock`).
- `--json` - emit JSON array instead of human table.
- `--target ssh --ssh-host <alias>` - list sessions on a remote host.

Each entry contains: **label**, **session**, **status**, **sessionAlive**, **reportExists**, **reportJsonPath**, **lastLines**, **updatedAt**.

Combine with OpenClaw to generate a periodic butler summary:
```
# In an OpenClaw prompt / cron:
bash {baseDir}/scripts/list-tasks.sh --json | \
  openclaw gateway call summarize-tasks --stdin
```

## Rules

- Prefer interactive Claude in tmux for visibility (not long `claude -p` one-shot for large tasks).
- Always include callback via wrapper `bash {baseDir}/scripts/wake.sh "..." now` in prompt.
- Startup script now uses robust submit (ready-check + multi-Enter retry + execution-state detection) to avoid "prompt pasted but not submitted".
- If no pane output for >2-3 min, inspect and restart session.
- Kill stale Claude processes before restart.
- Always return: session name + attach command + current status.

## Status check (zero-token)

If wake not received within expected time, check task status before consuming tokens:

```bash
bash {baseDir}/scripts/status-tmux-task.sh --label <label>
```

Output: `STATUS=running|likely_done|stuck|idle|dead|done_session_ended`

- `likely_done` / `done_session_ended` → proceed to completion loop
- `running` → wait
- `stuck` → inspect (attach or capture-pane)
- `dead` → session lost, run complete-tmux-task.sh fallback
- `idle` → Claude may be waiting for input, inspect

## Completion loop (mandatory)

When wake event "Claude Code done (...)" arrives, complete this loop immediately:

1. Acknowledge user within 60s: "已收到完成信号，正在评估改动".
2. Preferred path: read completion report generated by Claude Code task:
   - `/tmp/cc-<label>-completion-report.json`
3. If report missing, run local fallback immediately:
   - `bash {baseDir}/scripts/complete-tmux-task.sh --label <label> --workdir <workdir>`
4. **Mandatory deep-read**: read full JSON/MD report before replying.
5. Read context before replying:
   - Read completion report file(s) (`/tmp/cc-<label>-completion-report.json/.md`)
   - Read recent tmux transcript (monitor script) to capture what Claude actually did/failed/tried
   - Incorporate the latest user constraints from current chat
6. Then provide assistant analysis (not a fixed template):
   - what was actually completed
   - what is reliable vs uncertain
   - key risks/tradeoffs in the user's context
   - concrete next-step options
7. Ask explicit decision from user if scope drift exists.

Do not stop at wake-only notification. Wake is trigger, not final delivery.

### Anti-pattern to avoid
- Forbidden: one-line fixed reply after wake without reading transcript + report.
- Forbidden: only relaying "done + report path" without analysis in user context.
- Forbidden: rigid templated output that ignores current conversation context.

## Hard guardrails added

- Prompt now enforces "no wake without report":
  - task must write `/tmp/cc-<label>-completion-report.json` + `.md`
  - final wake must include `report=<json_path>`
- Recovery command exists for deterministic fallback:
  - `scripts/complete-tmux-task.sh` reproduces evidence and emits structured report
- Delivery SLA remains mandatory:
  - wake received -> ack <= 60s -> report

---

## 闭环反馈系统（新增）

任务执行现在会自动记录历史和执行日志，用于持续优化派活策略。

### 执行日志捕获

启动任务时会自动在后台运行 `capture-execution.sh`，捕获：
- 执行状态变化（thinking → executing → success/error）
- 工具调用成功/失败事件
- 执行时长和错误统计

日志文件：
- `/tmp/cc-<label>-execution-events.jsonl` — 事件流
- `/tmp/cc-<label>-execution-summary.json` — 执行摘要

### 任务历史记录

每次任务完成后，`complete-tmux-task.sh` 会自动记录到：
- `{baseDir}/TASK_HISTORY.jsonl`

记录内容：
```json
{
  "timestamp": "2026-02-17T10:00:00Z",
  "label": "task-name",
  "workdir": "/path/to/project",
  "success": true,
  "failureReason": "",
  "risk": "low",
  "durationSeconds": 300,
  "executionErrors": 0,
  "filesChanged": 5
}
```

### 历史分析

派活前检查历史，获取优化建议：

```bash
# 文本格式（人类可读）
bash {baseDir}/scripts/analyze-history.sh

# JSON 格式（程序处理）
bash {baseDir}/scripts/analyze-history.sh --json

# Markdown 格式（文档输出）
bash {baseDir}/scripts/analyze-history.sh --markdown
```

输出包括：
- 总体成功率统计
- 最近 7 天趋势
- 常见失败模式
- 针对性优化建议

### 派活前检查（推荐流程）

在启动新任务前，先检查历史：

```bash
bash {baseDir}/scripts/analyze-history.sh
```

根据分析结果调整任务描述：
- 如果 lint 失败频繁 → 在任务中增加 `npm install` 步骤
- 如果超时频繁 → 拆分为更小的子任务
- 如果成功率 < 80% → 增加任务描述的具体性

### 闭环优化原理

```
派活 → 执行 → 捕获日志 → 分析失败 → 记录历史 → 优化派活策略
  ↑                                                    ↓
  └────────────────── 持续改进 ←──────────────────────┘
```

核心思想（参考胡渊鸣的实践）：
- 给 Agent 提供闭环反馈环境
- 让系统能看到自己做的结果
- 让系统能分析哪里出了问题
- 让系统能据此改进

预期效果：
- 初始成功率：~60-70%
- 优化后成功率：~90-95%
